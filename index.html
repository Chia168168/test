<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片尺寸調整與格式轉換（支援多檔案/資料夾）</title>
    <script src="https://unpkg.com/heic2any@0.0.4/dist/heic2any.min.js"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .controls div {
            margin: 5px;
        }
        .note {
            color: #555;
            font-size: 0.9em;
        }
        #fileList {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .thumbnail-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .thumbnail {
            max-width: 150px;
            max-height: 150px;
            object-fit: contain;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>圖片尺寸調整與格式轉換</h1>
        
        <div>
            <label>選擇檔案或資料夾:</label><br>
            <input type="file" id="imageInput" accept="image/*,.heic,.heif" multiple>
            <input type="file" id="folderInput" webkitdirectory style="margin-top: 10px;">
        </div>
        
        <div>
            <h3>已選擇的檔案:</h3>
            <div id="fileList"></div>
        </div>
        
        <div class="controls">
            <div>
                <label>尺寸設定:</label>
                <select id="dimensionMode">
                    <option value="both">寬度與高度</option>
                    <option value="width">固定寬度</option>
                    <option value="height">固定高度</option>
                </select>
            </div>
            <div>
                <label>寬度 (px):</label>
                <input type="number" id="widthInput" min="1" placeholder="原始寬度">
            </div>
            <div>
                <label>高度 (px):</label>
                <input type="number" id="heightInput" min="1" placeholder="原始高度">
            </div>
            <div>
                <label>保持比例:</label>
                <input type="checkbox" id="aspectRatio" checked>
            </div>
            <div>
                <label>輸出格式:</label>
                <select id="formatSelect">
                    <option value="image/jpeg">JPEG</option>
                    <option value="image/png">PNG</option>
                    <option value="image/webp">WebP</option>
                </select>
            </div>
            <div>
                <label>品質 (僅JPEG/WebP):</label>
                <input type="number" id="qualityInput" min="0" max="100" value="80">
            </div>
        </div>
        
        <p class="note">注意：目前僅支援 JPEG、PNG 和 WebP 作為輸出格式。HEIC/HEIF 輸入已支援，但輸出需要後端處理。多檔案處理將自動打包為 ZIP 檔案。</p>
        
        <button onclick="processImages()">處理圖片</button>
        
        <div>
            <h3>縮圖預覽:</h3>
            <div id="previewContainer" class="thumbnail-container"></div>
        </div>
        
        <div>
            <a id="downloadLink" style="display: none;">下載處理後的圖片</a>
        </div>
    </div>

    <script>
        let originalImages = [];
        let processedBlobs = [];

        // 處理檔案輸入（單檔案或多檔案）
        document.getElementById('imageInput').addEventListener('change', handleFileSelect);
        document.getElementById('folderInput').addEventListener('change', handleFileSelect);

        function handleFileSelect(e) {
            const files = e.target.files;
            if (!files || files.length === 0) return;

            originalImages = [];
            processedBlobs = [];
            document.getElementById('fileList').innerHTML = '';
            document.getElementById('previewContainer').innerHTML = '';

            Array.from(files).forEach((file, index) => {
                const listItem = document.createElement('div');
                listItem.textContent = file.name;
                document.getElementById('fileList').appendChild(listItem);

                const isHeicHeif = file.name.toLowerCase().endsWith('.heic') || file.name.toLowerCase().endsWith('.heif');

                if (isHeicHeif) {
                    heic2any({ blob: file, toType: 'image/png' })
                        .then(result => {
                            handleImageLoad(file, URL.createObjectURL(result), index);
                        })
                        .catch(err => {
                            console.warn(`HEIC/HEIF 轉換失敗 (${file.name})，嘗試作為其他格式處理:`, err);
                            const reader = new FileReader();
                            reader.onload = function(e) {
                                handleImageLoad(file, e.target.result, index);
                            };
                            reader.readAsDataURL(file);
                        });
                } else {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        handleImageLoad(file, e.target.result, index);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function handleImageLoad(file, imageSrc, index) {
            const img = new Image();
            img.onload = function() {
                originalImages[index] = { file, img };
                if (index === 0) {
                    document.getElementById('widthInput').placeholder = img.width;
                    document.getElementById('heightInput').placeholder = img.height;
                }
                // 顯示縮圖
                const thumbnail = document.createElement('img');
                thumbnail.src = imageSrc;
                thumbnail.className = 'thumbnail';
                thumbnail.dataset.index = index;
                thumbnail.title = file.name;
                document.getElementById('previewContainer').appendChild(thumbnail);
            };
            img.onerror = function() {
                alert(`無法載入圖片：${file.name}，請確認檔案格式是否正確！`);
            };
            img.src = imageSrc;
        }

        document.getElementById('widthInput').addEventListener('input', updateDimensions);
        document.getElementById('heightInput').addEventListener('input', updateDimensions);
        document.getElementById('dimensionMode').addEventListener('change', updateDimensions);

        function updateDimensions() {
            if (!originalImages[0] || !document.getElementById('aspectRatio').checked) return;

            const mode = document.getElementById('dimensionMode').value;
            const width = parseInt(document.getElementById('widthInput').value);
            const height = parseInt(document.getElementById('heightInput').value);
            const ratio = originalImages[0].img.height / originalImages[0].img.width;

            if (mode === 'width' && width > 0) {
                document.getElementById('heightInput').value = Math.round(width * ratio);
            } else if (mode === 'height' && height > 0) {
                document.getElementById('widthInput').value = Math.round(height / ratio);
            } else if (mode === 'both') {
                if (width > 0) {
                    document.getElementById('heightInput').value = Math.round(width * ratio);
                } else if (height > 0) {
                    document.getElementById('widthInput').value = Math.round(height / ratio);
                }
            }
        }

        async function processImages() {
            if (originalImages.length === 0) {
                alert('請先選擇圖片！');
                return;
            }

            const format = document.getElementById('formatSelect').value;
            const quality = parseInt(document.getElementById('qualityInput').value) / 100;
            const mode = document.getElementById('dimensionMode').value;
            const widthInput = parseInt(document.getElementById('widthInput').value);
            const heightInput = parseInt(document.getElementById('heightInput').value);
            processedBlobs = [];

            const zip = new JSZip();

            for (let i = 0; i < originalImages.length; i++) {
                const { file, img } = originalImages[i];
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                let width = widthInput || img.width;
                let height = heightInput || img.height;

                if (document.getElementById('aspectRatio').checked) {
                    const ratio = img.height / img.width;
                    if (mode === 'width' && widthInput) {
                        height = Math.round(widthInput * ratio);
                    } else if (mode === 'height' && heightInput) {
                        width = Math.round(heightInput / ratio);
                    } else if (!widthInput && !heightInput) {
                        width = img.width;
                        height = img.height;
                    }
                }

                canvas.width = width;
                canvas.height = height;
                ctx.drawImage(img, 0, 0, width, height);

                const blob = await new Promise(resolve => {
                    canvas.toBlob(resolve, format, quality);
                });

                const originalName = file.name.split('.').slice(0, -1).join('.');
                const extension = format.split('/')[1];
                const newFileName = `${originalName}_${width}x${height}.${extension}`;
                processedBlobs.push({ blob, name: newFileName });

                if (originalImages.length > 1) {
                    zip.file(newFileName, blob);
                }

                // 更新縮圖
                const thumbnail = document.querySelector(`.thumbnail[data-index="${i}"]`);
                if (thumbnail) {
                    thumbnail.src = URL.createObjectURL(blob);
                }
            }

            const downloadLink = document.getElementById('downloadLink');
            downloadLink.style.display = 'block';

            if (originalImages.length === 1) {
                const { blob, name } = processedBlobs[0];
                downloadLink.href = URL.createObjectURL(blob);
                downloadLink.download = name;
                downloadLink.textContent = '下載處理後的圖片';
            } else {
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                downloadLink.href = URL.createObjectURL(zipBlob);
                downloadLink.download = 'processed_images.zip';
                downloadLink.textContent = '下載 ZIP 壓縮檔';
            }
        }
    </script>
</body>
</html>
