<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>圖片 ↔ Base64 工具</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { text-align: center; }

    /* 分頁按鈕 */
    .tab-buttons { text-align: center; margin-bottom: 20px; }
    .tab-buttons button {
      display: inline-block;
      width: 45%;
      margin: 0 5px;
      padding: 12px;
      font-size: 18px;
      font-weight: bold;
      background: #003366;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .tab-buttons button.active { background: #0055aa; }

    /* 功能分頁 */
    .tab { display: none; }
    .tab.active { display: block; }

    /* 輸出區 */
    .thumbs { display: flex; flex-wrap: wrap; margin-top: 20px; }
    .thumb { border: 1px solid #ccc; margin: 5px; padding: 5px; text-align: center; }
    .thumb img { max-width: 150px; max-height: 150px; display: block; margin-bottom: 5px; }
    .meta { font-size: 12px; color: #333; }

    /* 大藍按鈕 */
    button.big {
      display: block;
      width: 100%;
      padding: 15px;
      margin-top: 10px;
      font-size: 18px;
      font-weight: bold;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button.big:hover { background: #0056b3; }
    label { display:block; margin-top:10px; }
  </style>
</head>
<body>
  <h1>📷 圖片 ↔ Base64 工具</h1>

  <!-- 分頁按鈕 -->
  <div class="tab-buttons">
    <button class="tab-btn active" data-tab="tab1">圖片 ↔ Base64</button>
    <button class="tab-btn" data-tab="tab2">尺寸格式調整</button>
  </div>

  <!-- Tab 1 -->
  <div id="tab1" class="tab active">
    <input type="file" id="fileInput1" multiple>
    <button class="big" onclick="convertToBase64()">轉換成 Base64</button>
    <textarea id="base64Output" rows="10" style="width:100%;margin-top:10px;"></textarea>
    <button class="big" onclick="convertToImage()">Base64 ➝ 圖片</button>
    <div id="preview"></div>
  </div>

  <!-- Tab 2 -->
  <div id="tab2" class="tab">
    <input type="file" id="fileInput2" multiple>
    <label>輸出品質:
      <input type="range" id="quality" min="10" max="100" value="90">
    </label>

    <label>長邊
      <select id="longSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input type="number" id="longSideCustom" placeholder="自訂長邊" style="display:none; margin-top:5px;">
    </label>

    <label>短邊
      <select id="shortSide">
        <option value="0" selected>原尺寸</option>
        <option value="512">512</option>
        <option value="1024">1024</option>
        <option value="1280">1280</option>
        <option value="-1">自訂</option>
      </select>
      <input type="number" id="shortSideCustom" placeholder="自訂短邊" style="display:none; margin-top:5px;">
    </label>

    <button class="big" onclick="processImages()">開始處理</button>
    <div class="thumbs" id="thumbs"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/pica@8.0.0/dist/pica.min.js"></script>
  <script>
    const picaInstance = pica();

    // 分頁切換
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab').forEach(tab=>tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById(btn.dataset.tab).classList.add('active');
        btn.classList.add('active');
      });
    });

    // Base64 轉換
    function convertToBase64(){
      const files = document.getElementById('fileInput1').files;
      if(!files.length) return alert("請選擇圖片");
      const reader = new FileReader();
      reader.onload = e=>{
        document.getElementById('base64Output').value = e.target.result;
      };
      reader.readAsDataURL(files[0]);
    }
    function convertToImage(){
      let base64 = document.getElementById('base64Output').value.trim();
      if(!base64) return alert("請貼上 Base64 字串");
      if(!base64.startsWith("data:image")) base64 = "data:image/png;base64," + base64;
      const img = new Image(); img.src = base64;
      document.getElementById('preview').innerHTML="";
      document.getElementById('preview').appendChild(img);
    }

    // 自訂長短邊顯示
    document.getElementById("longSide").addEventListener("change", e=>{
      document.getElementById("longSideCustom").style.display = e.target.value == "-1" ? "block" : "none";
    });
    document.getElementById("shortSide").addEventListener("change", e=>{
      document.getElementById("shortSideCustom").style.display = e.target.value == "-1" ? "block" : "none";
    });

    function calcTargetSize(srcW,srcH){
      let w=srcW,h=srcH;
      const longSel = Number(document.getElementById('longSide').value);
      const longCustom = Number(document.getElementById('longSideCustom').value);
      const shortSel = Number(document.getElementById('shortSide').value);
      const shortCustom = Number(document.getElementById('shortSideCustom').value);

      let long = Math.max(w,h);
      let short = Math.min(w,h);

      if(longSel>0 && longSel!=-1) long = longSel;
      if(longSel==-1 && longCustom>0) long = longCustom;
      if(shortSel>0 && shortSel!=-1) short = shortSel;
      if(shortSel==-1 && shortCustom>0) short = shortCustom;

      const aspect = srcW/srcH;
      if(w>=h){ w=long; h=short||Math.round(long/aspect); }
      else { h=long; w=short||Math.round(long*aspect); }
      return {w,h};
    }

    function addThumb(src,name,srcW,srcH,dstW,dstH){
      const div=document.createElement('div'); div.className='thumb';
      const img=new Image(); img.src=src; div.appendChild(img);
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML=`${name}<br>原始: ${srcW}×${srcH}<br>輸出: ${dstW}×${dstH}`;
      div.appendChild(meta);
      document.getElementById("thumbs").appendChild(div);
    }

    async function processImages(){
      const files=document.getElementById('fileInput2').files;
      if(!files.length) return alert("請選擇圖片");
      document.getElementById("thumbs").innerHTML="";
      for(const file of files){
        const img=await readAsImage(file);
        const {w,h}=calcTargetSize(img.naturalWidth,img.naturalHeight);
        const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
        await picaInstance.resize(img,canvas,{quality:3,alpha:true});
        const outBlob=await picaInstance.toBlob(canvas,"image/png",1);
        addThumb(URL.createObjectURL(outBlob),file.name,img.naturalWidth,img.naturalHeight,w,h);
      }
    }

    function readAsImage(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>{
          const img=new Image();
          img.onload=()=>resolve(img);
          img.onerror=reject;
          img.src=e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>
