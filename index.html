<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>圖片 ↔ Base64 工具</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
    h1 { color: #003366; }
    .button {
      background-color: #007BFF;
      color: white;
      font-size: 18px;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }
    .button:hover { background-color: #0056b3; }
    #preview { margin-top: 20px; max-width: 90%; }
    select, input { font-size: 16px; margin-top: 10px; }
    #sizeHint { margin-top: 8px; color: #444; font-size: 15px; }
  </style>
</head>
<body>
  <h1>圖片 ↔ Base64 工具</h1>

  <!-- 選擇檔案 -->
  <input type="file" id="fileInput" class="button" accept="image/*" value="選擇檔案">
  <button class="button" onclick="clearAll()">清空</button>

  <br><br>

  <!-- 輸出尺寸選項 -->
  <label for="resizeMode">輸出尺寸：</label>
  <select id="resizeMode">
    <optgroup label="長邊">
      <option value="long-original">原尺寸</option>
      <option value="long-512">512</option>
      <option value="long-1024">1024</option>
      <option value="long-1280">1280</option>
      <option value="long-custom">自訂</option>
    </optgroup>
    <optgroup label="短邊">
      <option value="short-original">原尺寸</option>
      <option value="short-512">512</option>
      <option value="short-1024">1024</option>
      <option value="short-1280">1280</option>
      <option value="short-custom">自訂</option>
    </optgroup>
  </select>

  <input type="number" id="customSize" placeholder="輸入自訂尺寸" style="display:none; margin-top:5px;">
  <div id="sizeHint">尚未選擇圖片</div>

  <br><br>
  <button class="button" onclick="convertToBase64()">圖片 → Base64</button>
  <button class="button" onclick="convertToImage()">Base64 → 圖片</button>

  <!-- 預覽 -->
  <div id="preview"></div>
  <button id="downloadBtn" class="button" style="display:none;" onclick="downloadImage()">下載縮放後圖片</button>

  <script>
    const fileInput = document.getElementById('fileInput');
    const preview = document.getElementById('preview');
    const sizeHint = document.getElementById('sizeHint');
    const downloadBtn = document.getElementById('downloadBtn');
    let loadedImg = null; 
    let latestResizedBase64 = null; 

    document.getElementById('resizeMode').addEventListener('change', updatePreview);
    document.getElementById('customSize').addEventListener('input', updatePreview);
    fileInput.addEventListener('change', () => {
      const file = fileInput.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        loadedImg = new Image();
        loadedImg.onload = updatePreview;
        loadedImg.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    function clearAll() {
      fileInput.value = "";
      preview.innerHTML = "";
      document.getElementById('customSize').value = "";
      sizeHint.innerText = "尚未選擇圖片";
      loadedImg = null;
      latestResizedBase64 = null;
      downloadBtn.style.display = "none";
    }

    function calcTargetSize(originalW, originalH) {
      const mode = document.getElementById('resizeMode').value;
      const customValue = Number(document.getElementById('customSize').value);

      let targetW = originalW;
      let targetH = originalH;

      if (mode.startsWith("long")) {
        let size = getSizeFromMode(mode, customValue);
        if (size > 0) {
          if (originalW >= originalH) {
            targetW = size;
            targetH = Math.round(originalH * (size / originalW));
          } else {
            targetH = size;
            targetW = Math.round(originalW * (size / originalH));
          }
        }
      } else if (mode.startsWith("short")) {
        let size = getSizeFromMode(mode, customValue);
        if (size > 0) {
          if (originalW <= originalH) {
            targetW = size;
            targetH = Math.round(originalH * (size / originalW));
          } else {
            targetH = size;
            targetW = Math.round(originalW * (size / originalH));
          }
        }
      }
      return { w: targetW, h: targetH };
    }

    function getSizeFromMode(mode, customValue) {
      document.getElementById('customSize').style.display =
        mode.endsWith("custom") ? "block" : "none";

      if (mode.endsWith("original")) return 0;
      if (mode.endsWith("512")) return 512;
      if (mode.endsWith("1024")) return 1024;
      if (mode.endsWith("1280")) return 1280;
      if (mode.endsWith("custom")) return customValue > 0 ? customValue : 0;
      return 0;
    }

    function updatePreview() {
      if (!loadedImg) {
        sizeHint.innerText = "尚未選擇圖片";
        preview.innerHTML = "";
        downloadBtn.style.display = "none";
        return;
      }
      const { w, h } = calcTargetSize(loadedImg.width, loadedImg.height);
      sizeHint.innerText = `原始尺寸：${loadedImg.width} × ${loadedImg.height} → 輸出尺寸：${w} × ${h}`;

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(loadedImg, 0, 0, w, h);
      latestResizedBase64 = canvas.toDataURL("image/png");

      preview.innerHTML = `<img src="${latestResizedBase64}" style="max-width:100%; margin-top:10px;">`;
      downloadBtn.style.display = "inline-block";
    }

    function convertToBase64() {
      if (!loadedImg) return alert("請先選擇圖片");
      updatePreview(); 
      preview.innerHTML = `<textarea style="width:90%;height:150px;">${latestResizedBase64}</textarea><br><img src="${latestResizedBase64}" style="max-width:100%; margin-top:10px;">`;
    }

    function convertToImage() {
      const base64Text = prompt("請貼上 Base64：");
      if (!base64Text) return;
      let base64 = base64Text.trim();
      if (!base64.startsWith("data:image")) {
        base64 = "data:image/png;base64," + base64;
      }
      const img = new Image();
      img.onload = function() {
        loadedImg = img;
        updatePreview();
      };
      img.src = base64;
    }

    function downloadImage() {
      if (!latestResizedBase64) return alert("沒有可下載的圖片");
      const a = document.createElement("a");
      a.href = latestResizedBase64;
      a.download = "resized_image.png";
      a.click();
    }
  </script>
</body>
</html>
